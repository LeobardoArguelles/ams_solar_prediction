---
title: "Reporte de avance"
output: html_notebook
date: "2022-10-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r funciones_auxiliares, include=FALSE}

# Get dates with needed format
time <- ncvar_get(dlwrf, "time")
dates <- as.Date(as.POSIXct(time*3600, origin='1800-01-01 00:00:00', 'UTC'))
dates <- gsub('-', '', dates)
dates <- strtoi(dates)

namedSeq <- function(name, stop, steps=1, start=1) {
  return(paste(name, seq(from=start, to=stop, by=steps), sep=""))
}

nameCols <- function(data) {
  dimnames(data)[[5]] <- dates
  ## Latitud
  dimnames(data)[[2]] <- namedSeq("", 39, start=31)
  ## Longitud
  dimnames(data)[[1]] <- namedSeq("", 269-360, start=254-360)
  dimnames(data)[[4]] <- namedSeq("ens_", 11)
  dimnames(data)[[3]] <- namedSeq("fhour_", 24, steps=3, start=12)
  
  return (data)
}
```


# Preparación

## Librerías
```{r librerias}
library(ncdf4)
library(car)
```

## Cargar datos

### Predictores
```{r cargar_predictores}
## Precipitación
apcp <- nc_open("../../data/train/apcp_sfc_latlon_subset_19940101_20071231.nc") 
## Flujo de radiación, onda larga
dlwrf <- nc_open("../../data/train/dlwrf_sfc_latlon_subset_19940101_20071231.nc")
## Flujo de radiación, onda corta
dswrf <- nc_open("../../data/train/dswrf_sfc_latlon_subset_19940101_20071231.nc") 
## Presión atmosférica
pres_msl <- nc_open("../../data/train/pres_msl_latlon_subset_19940101_20071231.nc") 
## Agua precipitable
pwat <- nc_open("../../data/train/pwat_eatm_latlon_subset_19940101_20071231.nc") 
## Humedad específica, 2 metros sobre el nivel del mar
spfh <- nc_open("../../data/train/spfh_2m_latlon_subset_19940101_20071231.nc")
## Porcentaje de cielo nublado
tcdc <- nc_open("../../data/train/tcdc_eatm_latlon_subset_19940101_20071231.nc")
## Nivel de condensación
tcolc <- nc_open("../../data/train/tcolc_eatm_latlon_subset_19940101_20071231.nc")
## Temperatura máxma
tmax <- nc_open("../../data/train/tmax_2m_latlon_subset_19940101_20071231.nc")
## Temperatura mínima
tmin <- nc_open("../../data/train/tmin_2m_latlon_subset_19940101_20071231.nc")
## Temperatura actual, dos metros sobre la superficie
tmp.2m <- nc_open("../../data/train/tmp_2m_latlon_subset_19940101_20071231.nc")
## Temperatura en la superficie
tmp.sfc <-nc_open("../../data/train/tmp_sfc_latlon_subset_19940101_20071231.nc")
## Radiación onda larga en la superficie
ulwrf.sfc <- nc_open("../../data/train/ulwrf_sfc_latlon_subset_19940101_20071231.nc")
## Radiación onda larga en la atmosfera
ulwrf.atm <- nc_open("../../data/train/ulwrf_tatm_latlon_subset_19940101_20071231.nc")
## Radiación onda corta en la superficie
uswrf <- nc_open("../../data/train/uswrf_sfc_latlon_subset_19940101_20071231.nc")
```

### Datos de las estaciones
```{r estaciones}
stations <- read.csv("../../data/station_info.csv")
```

### Resultados de entrenamiento
```{r energy_train}
energy_train <- read.csv("../../data/train.csv")
```
# Exploración de los datos

Todos los predictores tienen el mismo formato:

**3 variables:**

* intTime
* intValidTime
* *\<Variable de interés\>*

**Cada variable tiene 5 dimensiones:**

* time
* lat
* lon
* ens
* fhour
  
```{r exploracion_general}
print(attributes(dlwrf$var))
print(attributes(dswrf$var))

# Ver el formato
print(dlwrf)
```
## Datos de interés
Cada variable tiene exactamente las mismas cinco dimensiones. 
Del resumen impreso arriba podemos rescatar los siguientes valores importantes:

Dimensión     | Tamaño      | Valor Mínimo    | Valor Máximo    |
------------- | ------------|-----------------|-----------------|
Latitud       | 9           | 31              | 39             |
Longitud       | 16           | 254              | 269             |
Ensemble       | 11           | 1              | 11             |
fHour       | 5           | 12              | 24             |
Tiempo       | 5113           |  1700586             | 1823256    |

### Latitud y Longitud

Representan valores en la zona geográfica de interés.

En esta área, solo toman los siguientes valores:

* Latitud: [31° - 39°]
* Longitud: [254° - 269°]

![Mapa de las estaciones meteorológicas y los sitios de medición](../common/imgs/mapa.png)

En estos datos, la longitud está en **grados positivos desde el meridiano cero**,
llegando hasta 360°.
Por otro lado, las coordenadas de las estaciones meteorológicas tienen este dato
en valores que van de 0° a 180°, ya sea al Este u Oeste.

```{r longitud_estaciones}
head(stations)
```

Esto será tomado en cuenta al etiquetar la longitud en los datos de entrenamiento.

```{r ncvar_get_vars}
# Primero obtener las variables de interés
apcp.data <- ncvar_get(apcp, "Total_precipitation")
dlwrf.data <- ncvar_get(dlwrf, "Downward_Long-Wave_Rad_Flux")
dswrf.data <- ncvar_get(dswrf, "Downward_Short-Wave_Rad_Flux")
pres_msl.data <- ncvar_get(pres_msl, "Pressure")
pwat.data <- ncvar_get(pwat, "Precipitable_water")
spfh.data <- ncvar_get(spfh, "Specific_humidity_height_above_ground")
tcdc.data <- ncvar_get(tcdc, "Total_cloud_cover")
tcolc.data <- ncvar_get(tcolc, "Total_Column-Integrated_Condensate")
tmax.data <- ncvar_get(tmax, "Maximum_temperature")
tmin.data <- ncvar_get(tmin, "Minimum_temperature")
tmp2m.data <- ncvar_get(tmp.2m, "Temperature_height_above_ground")
tmpsfc.data <- ncvar_get(tmp.sfc, "Temperature_surface")
ulwrfsfc.data <- ncvar_get(ulwrf.sfc, "Upward_Long-Wave_Rad_Flux_surface")
ulwrfatm.data <- ncvar_get(ulwrf.atm, "Upward_Long-Wave_Rad_Flux")
uswrf.data <- ncvar_get(uswrf, "Upward_Short-Wave_Rad_Flux")
```

```{r etiquetar_datos}
apcp.data <- nameCols(apcp.data)
dlwrf.data <- nameCols(dlwrf.data)
dswrf.data <- nameCols(dswrf.data)
pres_msl.data <- nameCols(pres_msl.data)
pwat.data <- nameCols(pwat.data)
spfh.data <- nameCols(spfh.data)
tcdc.data <- nameCols(tcdc.data)
tcolc.data <- nameCols(tcolc.data)
tmax.data <- nameCols(tmax.data)
tmin.data <- nameCols(tmin.data)
tmp2m.data <- nameCols(tmp2m.data)
tmpsfc.data <- nameCols(tmpsfc.data)
ulwrfsfc.data <- nameCols(ulwrfsfc.data)
ulwrfatm.data <- nameCols(ulwrfatm.data)
uswrf.data <- nameCols(uswrf.data)

# Muestra de como queda etiquetado
#print(dlwrf.data[,,,,])
```
### Ensemble
De acuerdo con el [glosario](https://forecast.weather.gov/glossary.php?word=ENSEMBLE)
de la agencia que provee el conjunto de datos, un *ensemble* se define como:

> Colección de modelos numéricos que muestran resultados ligeramente diferentes.

```{r comparacion_ensembles}
e1 <- dlwrf.data[,,,1,]
e2 <- dlwrf.data[,,,2,]
e3 <- dlwrf.data[,,,3,]
e4 <- dlwrf.data[,,,4,]
e5 <- dlwrf.data[,,,5,]

comparativo <- c(e1[1,1,1,1], e2[1,1,1,1], e3[1,1,1,1], e4[1,1,1,1], e5[1,1,1,1])
print(comparativo)
```
El primer *ensemble* es el de control, y es el que será utilizado para este modelo.

```{r extraer_ensemble}
apcp.data.e1 <- apcp.data[,,,1,]
dlwrf.data.e1 <- dlwrf.data[,,,1,]
dswrf.data.e1 <- dswrf.data[,,,1,]
pres_msl.data.e1 <- pres_msl.data[,,,1,]
pwat.data.e1 <- pwat.data[,,,1,]
spfh.data.e1 <- spfh.data[,,,1,]
tcdc.data.e1 <- tcdc.data[,,,1,]
tcolc.data.e1 <- tcolc.data[,,,1,]
tmax.data.e1 <- tmax.data[,,,1,]
tmin.data.e1 <- tmin.data[,,,1,]
tmp2m.data.e1 <- tmp2m.data[,,,1,]
tmpsfc.data.e1 <- tmpsfc.data[,,,1,]
ulwrfsfc.data.e1 <- ulwrfsfc.data[,,,1,]
ulwrfatm.data.e1 <- ulwrfatm.data[,,,1,]
uswrf.data.e1 <- uswrf.data[,,,1,]

dim(dlwrf.data.e1)
```
### Forecast Hour
Es la hora a la cual la estación meteorológica hace su pronóstico sobre la 
variable de interés. Esto sucede cinco veces en el día: Empieza a las 12,
y se repite en intervalos de 3 horas, terminando a las 24.

```{r etiquetar_fhour}
#dimnames(dlwrf.data.e1)[[3]] <- namedSeq("fhour_", 24, steps=3, start=12)
#dimnames(dswrf.data.e1)[[3]] <- namedSeq("fhour_", 24, steps=3, start=12)

#print(dlwrf.data.e1[1,1,,1])
```
### Tiempo
Es la fecha en la que se tomó la medición de la variable. Esta columna corresponde
directamente con una de las respuestas en los datos de entrenamiento.

Sus valores son obtenidos de la variable `time` contenida en el conjunto de datos.

```{r extraer_tiempo}
# Todas las variables manejan el mismo tiempo
#time <- ncvar_get(dlwrf, "time")

# Diferente formato
#head(time)
#head(energy_train$Date)
```
Comparando la variable `time` con las fechas de los datos de entrenamiento, se 
observa que su formato no coincide. Cada una está representando su tiempo de 
forma distinta:

| Variable | Formato |
|----------|---------|
| `time` | Horas desde 1800-01-01 00:00:00 |
| `energy_train$Date` | Fecha formato YYYYMMDD |

Por lo tanto es necesario convertir nuestro tiempo en horas, a fecha.

```{r hora->fecha}
#dates <- as.Date(as.POSIXct(time*3600, origin='1800-01-01 00:00:00', 'UTC'))
#dates <- gsub('-', '', dates)
# Además, energy_train$Date tiene sus fechas como ints
#dates <- strtoi(dates)

#head(dates)
#head(energy_train$Date)
```
Con estos valores, se pueden etiquetar nuestros predictores:

```{r etiquetar_hora}
#dimnames(dlwrf.data.e1)[[4]] <- dates
#dimnames(dswrf.data.e1)[[4]] <- dates

#head(dlwrf.data.e1[1,1,1,])
```

# Preparar los subconjuntos de entrenamiento

## Predictores
En este primer experimento se hará un modelo solo para el sitio de generación 
**ACME**.

Para identificar los datos que son útiles para este sitio particular se utilizan
las coordenadas:

```{r coordenadas_acme}
print(names(stations))
acme <- stations[stations["stid"] == "ACME"]
print(acme)

# Se redondea porque los archivos de los predictores tienen coordenadas enteras.
# Se tomará la medición más cercana.
acme.lat <- as.character(round(as.numeric(acme[2])))
acme.lon <- as.character(round(as.numeric(acme[3])))
print(c(acme.lat, acme.lon))
```
Se determinó que las coordenadas más cercanas a ACME son: (35, -98).

Con estos datos extraemos las mediciones correspondientes.

```{r mediciones_acme}
acme.apcp <- apcp.data.e1[acme.lon, acme.lat, ,]
acme.dlwrf <- dlwrf.data.e1[acme.lon, acme.lat, ,]
acme.dswrf <- dswrf.data.e1[acme.lon, acme.lat, ,]
acme.pres_msl <- pres_msl.data.e1[acme.lon, acme.lat, ,]
acme.pwat <- pwat.data.e1[acme.lon, acme.lat, ,]
acme.spfh <- spfh.data.e1[acme.lon, acme.lat, ,]
acme.tcdc <- tcdc.data.e1[acme.lon, acme.lat, ,]
acme.tcolc <- tcolc.data.e1[acme.lon, acme.lat, ,]
acme.tmax <- tmax.data.e1[acme.lon, acme.lat, ,]
acme.tmin <- tmin.data.e1[acme.lon, acme.lat, ,]
acme.tmp2m <- tmp2m.data.e1[acme.lon, acme.lat, ,]
acme.tmpsfc <- tmpsfc.data.e1[acme.lon, acme.lat, ,]
acme.ulwrfsfc <- ulwrfsfc.data.e1[acme.lon, acme.lat, ,]
acme.ulwrfatm <- ulwrfatm.data.e1[acme.lon, acme.lat, ,]
acme.uswrf <- uswrf.data.e1[acme.lon, acme.lat, ,]
```

```{r promedios_mediciones}
# Para simplificar este primer experimento, se decidió promediar las predicciones
# a lo largo del día
acme.apcp.means <- colMeans(acme.apcp)
acme.dlwrf.means <- colMeans(acme.dlwrf)
acme.dswrf.means <- colMeans(acme.dswrf)
acme.pres_msl.means <- colMeans(acme.pres_msl)
acme.pwat.means <- colMeans(acme.pwat)
acme.spfh.means <- colMeans(acme.spfh)
acme.tcdc.means <- colMeans(acme.tcdc)
acme.tcolc.means <- colMeans(acme.tcolc)
acme.tmax.means <- colMeans(acme.tmax)
acme.tmin.means <- colMeans(acme.tmin)
acme.tmp2m.means <- colMeans(acme.tmp2m)
acme.tmpsfc.means <- colMeans(acme.tmpsfc)
acme.ulwrfsfc.means <- colMeans(acme.ulwrfsfc)
acme.ulwrfatm.means <- colMeans(acme.ulwrfatm)
acme.uswrf.means <- colMeans(acme.uswrf)
```

```{r acme_final}
acme.final <- data.frame(
  Date = names(acme.dlwrf.means),
  apcp = acme.apcp.means,
  dlwrf = acme.dlwrf.means,
  dswrf = acme.dswrf.means,
  pres_msl = acme.pres_msl.means,
  pwat = acme.pwat.means,
  spfh = acme.spfh.means,
  tcdc = acme.tcdc.means,
  tcolc = acme.tcolc.means,
  tmax = acme.tmax.means,
  tmin = acme.tmin.means,
  tmp2m = acme.tmp2m.means,
  tmpsfc = acme.tmpsfc.means,
  ulwrfsfc = acme.ulwrfsfc.means,
  ulwrfatm = acme.ulwrfatm.means,
  uswrf = acme.uswrf.means
)
print(acme.final)
```



## Respuesta esperada
Ya que se tienen los predictores, solo hace falta conocer cuánta energía se 
generó en ACME con esos valores de `dlwrf` y `dswrf`.

```{r energia_acme}
energy.acme <- energy[c("Date", "ACME")]
colnames(energy.acme) <- c("Date", "ACME")

# Hay que tener el mismo formato para combinarlo con nuestros predictores
energy.acme <- transform(energy.acme, Date=as.character(Date))
print(energy.acme)
```

Y se combina con los predictores en un solo Dataframe para poder crear modelos.
```{r crear_datos_entrenamiento_final}
energy.acme <- merge(energy.acme, acme.final, by="Date")
```

```{r}
print(names(energy.acme))
print(energy.acme)
```


# Creación de modelos
```{r}
cor(energy.acme[, -1])
```
```{r}
plot(energy.acme$ulwrfsfc, energy.acme$tmax)
```


## Regresión lineal múltiple
```{r rlm}
lmm.fit <- lm(ACME ~ poly(dlwrf, 2) + poly(dswrf, 3) + ulwrfatm + tmax +
            tmpsfc + pwat, data=energy.acme)
plot(lmm.fit)
print(vif(lmm.fit))
summary(lmm.fit)
```
**Best yet**
R^2: 0.8193
RSE: 3 348 000
Formula: ACME ~ poly(dlwrf, 2) + poly(dswrf, 3) + ulwrfatm + tmax + tmpsfc + pwat

Mean ACME: 16 877 462
RSE ~ 19.83%
```{r}
mean(energy.acme$ACME)
```

